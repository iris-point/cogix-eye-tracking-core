<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fullscreen Calibration with Background Tracking</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
      font-weight: bold;
      color: white;
    }
    
    .status-disconnected { background: #dc3545; }
    .status-connecting { background: #ffc107; }
    .status-connected { background: #28a745; }
    .status-calibrating { background: #17a2b8; }
    .status-tracking { background: #007bff; }
    
    .tracking-info {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .data-display {
      font-family: monospace;
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      min-height: 150px;
      white-space: pre-wrap;
    }
    
    .demo-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .demo-content h2 {
      margin-top: 0;
    }
    
    .gaze-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: red;
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      display: none;
    }
  </style>
</head>
<body>
  <!-- Gaze indicator that follows the eye -->
  <div id="gazeIndicator" class="gaze-indicator"></div>
  
  <div class="container">
    <h1>Fullscreen Calibration with Background Tracking</h1>
    
    <div class="controls">
      <h3>Connection & Calibration</h3>
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
      <button id="fullscreenCalibrationBtn" disabled>Start Fullscreen Calibration</button>
      <span class="status-badge" id="statusBadge">disconnected</span>
      
      <h3>Background Tracking</h3>
      <button id="startBackgroundBtn" disabled>Start Background Tracking</button>
      <button id="stopBackgroundBtn" disabled>Stop Background Tracking</button>
      <button id="toggleGazeBtn">Show Gaze Indicator</button>
    </div>
    
    <div class="tracking-info">
      <h3>Tracking Data (Updates in Background)</h3>
      <p>The eye tracker continues to collect data even when you interact with other page elements.</p>
      <div class="data-display" id="dataDisplay">
Waiting for connection...
      </div>
    </div>
    
    <div class="demo-content">
      <h2>Demo Content</h2>
      <p>This content remains interactive while tracking happens in the background.</p>
      <button onclick="alert('Button clicked! Tracking continues in background.')">Test Button</button>
      <br><br>
      <input type="text" placeholder="Type here while tracking continues..." style="width: 300px; padding: 5px;">
      <br><br>
      <label>
        <input type="checkbox"> Checkbox (tracking continues)
      </label>
    </div>
  </div>

  <!-- Load the library (use CDN path in production) -->
  <script src="../dist/cogix-eye-tracking-core.js"></script>
  
  <script>
    // Access via global object
    const { createEyeTracker, CalibrationUI, DeviceStatus } = IrisPointEyeTracking
    
    // Create tracker
    const tracker = createEyeTracker({
      debug: true,
      bufferSize: 5000
    })
    
    // Create fullscreen calibration UI
    const calibrationUI = new CalibrationUI({
      pointRadius: 25,
      pointColor: 'rgba(0, 255, 0, 0.9)',
      backgroundColor: 'rgba(0, 0, 0, 0.95)',
      showInstructions: true,
      instructionText: 'Follow the green dot with your eyes. Press ESC to cancel.',
      autoFullscreen: true
    })
    
    // UI Elements
    const connectBtn = document.getElementById('connectBtn')
    const disconnectBtn = document.getElementById('disconnectBtn')
    const fullscreenCalibrationBtn = document.getElementById('fullscreenCalibrationBtn')
    const startBackgroundBtn = document.getElementById('startBackgroundBtn')
    const stopBackgroundBtn = document.getElementById('stopBackgroundBtn')
    const toggleGazeBtn = document.getElementById('toggleGazeBtn')
    const statusBadge = document.getElementById('statusBadge')
    const dataDisplay = document.getElementById('dataDisplay')
    const gazeIndicator = document.getElementById('gazeIndicator')
    
    // State
    let isShowingGaze = false
    let dataCount = 0
    let isBackgroundTracking = false
    
    // Update UI based on status
    function updateUI(status) {
      statusBadge.textContent = status
      statusBadge.className = 'status-badge status-' + status
      
      connectBtn.disabled = status !== DeviceStatus.DISCONNECTED
      disconnectBtn.disabled = status === DeviceStatus.DISCONNECTED
      fullscreenCalibrationBtn.disabled = status !== DeviceStatus.CONNECTED
      startBackgroundBtn.disabled = status !== DeviceStatus.CONNECTED && status !== DeviceStatus.TRACKING
      stopBackgroundBtn.disabled = !isBackgroundTracking
    }
    
    // Format data display
    function formatDataDisplay(gazeData) {
      return `
=== BACKGROUND TRACKING ACTIVE ===
Timestamp: ${new Date(gazeData.timestamp).toLocaleTimeString()}
Position: (${gazeData.x.toFixed(3)}, ${gazeData.y.toFixed(3)})
Confidence: ${(gazeData.confidence || 0).toFixed(2)}
Sample #${dataCount}
Buffer Size: ${tracker.getRecentData(100).length} samples

Left Eye:  ${gazeData.leftEye ? `(${gazeData.leftEye.x.toFixed(3)}, ${gazeData.leftEye.y.toFixed(3)})` : 'N/A'}
Right Eye: ${gazeData.rightEye ? `(${gazeData.rightEye.x.toFixed(3)}, ${gazeData.rightEye.y.toFixed(3)})` : 'N/A'}

Status: ${isBackgroundTracking ? 'ðŸŸ¢ Tracking Active' : 'ðŸ”´ Tracking Stopped'}
      `.trim()
    }
    
    // Event Listeners
    tracker.on('statusChanged', (status) => {
      console.log('Status changed:', status)
      updateUI(status)
    })
    
    tracker.on('connected', () => {
      console.log('Connected to eye tracker')
      dataDisplay.textContent = 'Connected! Ready for calibration.'
    })
    
    tracker.on('disconnected', () => {
      console.log('Disconnected')
      dataDisplay.textContent = 'Disconnected from eye tracker.'
      calibrationUI.hide()
      isBackgroundTracking = false
    })
    
    tracker.on('error', (error) => {
      console.error('Error:', error)
      dataDisplay.textContent = `Error: ${error.message}`
    })
    
    // Background tracking - data continues even during UI interactions
    tracker.on('gazeData', (data) => {
      dataCount++
      
      // Update display
      dataDisplay.textContent = formatDataDisplay(data)
      
      // Update gaze indicator if showing
      if (isShowingGaze) {
        const x = data.x * window.innerWidth
        const y = data.y * window.innerHeight
        gazeIndicator.style.left = x + 'px'
        gazeIndicator.style.top = y + 'px'
      }
    })
    
    tracker.on('calibrationStarted', ({ points }) => {
      console.log(`Calibration started with ${points} points`)
      dataDisplay.textContent = `Fullscreen calibration started with ${points} points.`
    })
    
    tracker.on('calibrationProgress', ({ current, total }) => {
      console.log(`Calibration progress: ${current}/${total}`)
      
      // Update fullscreen UI
      if (current < total) {
        calibrationUI.showPoint(current)
      }
      
      dataDisplay.textContent = `Calibration progress: ${current}/${total} points completed`
    })
    
    tracker.on('calibrationComplete', (result) => {
      console.log('Calibration complete:', result)
      calibrationUI.hide()
      
      if (result.success) {
        dataDisplay.textContent = 'Calibration successful! Starting background tracking...'
        // Automatically start background tracking after calibration
        setTimeout(() => {
          startBackgroundTracking()
        }, 1000)
      } else {
        dataDisplay.textContent = 'Calibration failed. Please try again.'
      }
    })
    
    tracker.on('calibrationCancelled', () => {
      console.log('Calibration cancelled')
      calibrationUI.hide()
      dataDisplay.textContent = 'Calibration cancelled'
    })
    
    // Button Handlers
    connectBtn.addEventListener('click', async () => {
      try {
        dataDisplay.textContent = 'Connecting...'
        await tracker.connect()
      } catch (error) {
        console.error('Connection failed:', error)
        dataDisplay.textContent = `Connection failed: ${error.message}`
      }
    })
    
    disconnectBtn.addEventListener('click', () => {
      tracker.disconnect()
      calibrationUI.hide()
      isBackgroundTracking = false
      gazeIndicator.style.display = 'none'
    })
    
    fullscreenCalibrationBtn.addEventListener('click', () => {
      // Show fullscreen calibration UI
      calibrationUI.show()
      calibrationUI.showPoint(0)
      
      // Start tracker calibration
      tracker.startCalibration(5)
    })
    
    // Background tracking controls
    function startBackgroundTracking() {
      tracker.startBackgroundTracking()
      isBackgroundTracking = true
      stopBackgroundBtn.disabled = false
      dataDisplay.textContent = 'Background tracking started. Interact with the page - tracking continues!'
    }
    
    startBackgroundBtn.addEventListener('click', () => {
      startBackgroundTracking()
    })
    
    stopBackgroundBtn.addEventListener('click', () => {
      tracker.stopBackgroundTracking()
      isBackgroundTracking = false
      stopBackgroundBtn.disabled = true
      dataDisplay.textContent = 'Background tracking stopped.'
    })
    
    toggleGazeBtn.addEventListener('click', () => {
      isShowingGaze = !isShowingGaze
      gazeIndicator.style.display = isShowingGaze ? 'block' : 'none'
      toggleGazeBtn.textContent = isShowingGaze ? 'Hide Gaze Indicator' : 'Show Gaze Indicator'
    })
    
    // ESC key to cancel calibration
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && tracker.getStatus() === DeviceStatus.CALIBRATING) {
        tracker.cancelCalibration()
        calibrationUI.hide()
      }
    })
    
    // Polling example - check tracking data every second
    setInterval(() => {
      if (isBackgroundTracking) {
        const lastData = tracker.getLastGazeData()
        if (lastData) {
          console.log('Background poll - Last gaze:', lastData.x.toFixed(3), lastData.y.toFixed(3))
        }
      }
    }, 1000)
    
    // Initial UI state
    updateUI(DeviceStatus.DISCONNECTED)
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      calibrationUI.dispose()
      tracker.dispose()
    })
  </script>
</body>
</html>